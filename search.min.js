$.fn.search = function (a) { var i, r = this; r.css("width", a.width).addClass("search-input"); var t, d = $('<div name="result-area" style="width:' + this.outerWidth() + 'px;"></div>'), p = $('<img src="loading.png"/>'), e = $('<input type="text" autocomplete="off" name="search-field" placeholder="' + a.placeholder + '"/>'), n = $('<div name="badges-area"></div>'); r.append(e), r.append(n), r.append(p.hide()); var o = $("#" + r.attr("id") + " [name=search-field]"); function u() { if (o.val().length <= 1) return d.empty(), void p.hide(); var t = '{"' + a.arg + '" : "' + o.val() + '"}'; !function (t) { $.ajax({ type: "POST", url: t.url, data: t.param, contentType: "application/json;", dataType: "json", success: t.func, error: function () { console.log("error") } }) }({ url: a.url, param: t, func: function (t) { var e = JSON.parse(t.d); if (!e.length) return void p.hide(); var n = []; r.append(d), d.append('<input name="filter-items" placeholder="فیلتر..."/>'), $.each(e, function (t, e) { n.push("<li " + a.id + '="' + e[a.id] + '">' + e[a.text] + "</li>") }), d.append("<ul>" + n.join("") + "</ul>"), void 0 !== a.append && $("#" + r.attr("id") + " ul").prepend("<li " + a.id + '="' + a.append.id + '">' + a.append.text + "</li>"); i = $("#" + r.attr("id") + " ul li").clone(), p.hide(), s() } }) } function s(t) { return $("#" + r.attr("id") + " [name=badges-area] span[" + a.id + "=" + t + "]").length } function c() { var n = []; $("#" + r.attr("id") + " [name=badges-area] span").each(function (t, e) { n.push($(e).attr(a.id)) }), r.attr("value", n.join(",")) } o.on("keyup", function () { p.show(), d.empty(), clearTimeout(t), t = setTimeout(u, 1e3) }), o.on("keydown", function () { clearTimeout(t) }), $(window).click(function () { d.empty() }), $(".search-input").click(function (t) { t.stopPropagation() }), $("#" + r.attr("id")).on("click", "li", function (t) { !function (t, e) { if ("-1" == t) return n.empty(), n.append('<span id="' + t + '">' + e + "</span>"), $("#" + r.attr("id") + " input[name=search-field]").css("margin-bottom", "3px"), $("#" + r.attr("id") + " ul li").css("pointer-events", "none"), r.attr("value", "-1"); if (s(t)) return; n.append('<span id="' + t + '">' + e + "</span>"), $("#" + r.attr("id") + " input[name=search-field]").css("margin-bottom", "3px"), c(), void 0 !== a.func && a.func(t, e) }($(this).attr(a.id), $(this).text()) }), $("#" + r.attr("id")).on("click", "span", function (t) { "-1" == $(this).attr(a.id) && $("#" + r.attr("id") + " ul li").css("pointer-events", ""), $(this).remove(), c(), $("#" + r.attr("id") + " [name=badges-area] span").length || $("#" + r.attr("id") + " input[name=search-field]").css("margin-bottom", "") }), $("#" + r.attr("id")).on("keyup", "input[name=filter-items]", function () { var n = $(this).val(); $("#" + r.attr("id") + " ul").empty(), i.filter(function (t, e) { return "" === n || 0 <= $(e).text().indexOf(n) }).appendTo("#" + r.attr("id") + " ul") }) };